"use strict";var delay;this.App={isMergeView:!1},App.init=function(){return App.x2js=new X2JS({attributeArray:"_attributes"}),App.URIQuery=URI(document.location.href).query(!0),$.getJSON("config/config.json").done(function(e){return App.config=e,App.URIQuery.config?$.getJSON(App.URIQuery.config).done(function(r){return App.config=$.extend(e,r,{}),App.play()}):App.play()})},App.play=function(){return App.loadEditors(),App.bindEvents(),App.initConfigComponents(),App.insertQueryPicker(),pleaseWait.finish(),delay(1500,function(){return App.cm.sparql.refresh()})},App.loadEditors=function(){return App.cm={},App.cm.sparql=CodeMirror.fromTextArea(document.getElementById("codemirror"),{mode:"sparql",lineNumbers:!0,matchBrackets:!0,autoCloseBrackets:!0}),App.loadQuery("sparql",0),App.cm.rdf=CodeMirror.fromTextArea(document.getElementById("codemirror_rdf"),{lineNumbers:!0,mode:"n3",matchBrackets:!0,autoCloseBrackets:!0}),App.loadQuery("rdf",0),App.cm.rif=CodeMirror.fromTextArea(document.getElementById("codemirror_rif"),{lineNumbers:!0,mode:"rif",matchBrackets:!0,autoCloseBrackets:!0}),App.loadQuery("rif",0)},App.loadQuery=function(e,r){var t;return t=$(".load-query-status[data-lang="+e),t.show().html('<i class="fa fa-spinner"></i>'),$.ajax({url:App.config.defaultData[e][r],dataType:"text"}).done(function(r){return t.html('<i class="fa fa-check-circle"></i>').fadeOut(500),App.cm[e].getDoc().setValue(r)})},App.bindEvents=function(){return $(".query .get-graph").click(function(){var e;return e={query:"SELECT * WHERE { ?s ?p ?o. } LIMIT 10"},$.ajax({url:"http://localhost:8080/nonstandard/sparql/info",method:"POST",data:JSON.stringify(e),success:function(e){return createVerticalTree(e)}})}),$(".query .evaluate").click(function(){var e,r,t,n,i,s,p,a;for(n in App.cm)App.cm[n].save();if(p=$(this).data("target"),r=App.config.endpoints[0],e={query:$(this).parents(".query").find(".editor").val()},r.nonstandard){t=r[p],e.rdf=App.config.sendRDF?App.cm.rdf.getValue():"",s=t[1],i=t[0],e.formats=["xml","plain"];for(n in App.config.queryParameters)e[n]=App.config.queryParameters[n];e=JSON.stringify(e)}else s="GET",i=r.without;return a=""+App.config.endpoints[0].url+i,App.isMergeView&&$(".results-tab a").click(),$("#results-tab").html(JST.spinner()),$.ajax({url:a,method:s,data:e,success:function(e){return App.processResults(e,p)}})}),$(document).foundation({tab:{callback:function(e){var r;return r=$(e.children("a").attr("href")),r.find(".CodeMirror").length?r.find(".CodeMirror")[0].CodeMirror.refresh():void 0}}}),$(".error-log button").click(function(){return $(this).next().toggleClass("visible")}),$(".query-select").change(function(){var e,r;return r=$(this).data("lang"),e=$(this).find("option:selected").index(),App.loadQuery(r,e)}),$(".fullscreen-toggle").click(function(){return $(".main-section").toggleClass("full"),$(this).toggleClass("active")}),$(".right-side-toggle").click(function(){return $(".left-side .right-side-tab").length?($(".right-side-tab-content").appendTo($(".right-side .tabs-content")),$(".right-side-tab").appendTo($(".right-side .tabs")),$(".right-side").show(),$(".right-side .tabs a").get(0).click()):($(".right-side-tab-content").appendTo($(".left-side .tabs-content")),$(".right-side-tab").appendTo($(".left-side .tabs")),$(".right-side").hide()),$(this).toggleClass("active"),$(".left-side").toggleClass("medium-6 medium-12"),$(".left-side .tabs a").get(0).click(),App.isMergeView=!App.isMergeView})},App.insertQueryPicker=function(){var e,r;r=[];for(e in{sparql:"sparql",rdf:"rdf",rif:"rif"})r.push($("#query-select-"+e).html(JST.query_picker({options:App.config.defaultData[e]})));return r},App.preprocessResults=function(e){var r,t,n,i;if(t=[],i=e,App.config.endpoints[App.config.selectedEndpoint].nonstandard&&("triples"in e&&t.push(App.processTriples(e.triples)),"predicates"in e&&t.push(App.processPredicates(e.predicates)),"XML"in e))if(""===e.XML[0])t.push(App.emptyResultSet());else try{i=$.parseXML(e.XML[0])}catch(s){r=s}return $.isXMLDoc(i)&&(n=App.x2js.xml2json(i),t.push(App.processSparql(n))),t},App.processResults=function(e,r){var t,n,i,s,p;if(s=App.preprocessResults(e),s.length){i={},t={},App.config.sendRDF&&$.extend(i,App.parseRDFPrefixes(App.cm.rdf.getValue())),"rif"===r&&$.extend(i,App.parseRIFPrefixes(App.cm.rif.getValue()));for(n in i)p=i[n],t[n]=randomColor({luminosity:"dark"});return App.prefixResultSets(s,i,t),$("#results-tab").html(JST.results({resultSets:s,prefixes:i,colors:t}))}return"queryError"in e?App.logError("Sparql: "+e.queryError.errorMessage,r,e.queryError.line):"rdfError"in e?App.logError("RDF: "+e.rdfError.errorMessage,"rdf",e.rdfError.line):"rifError"in e?App.logError("RIF: "+e.rifError.errorMessage,"rif",e.rifError.line):App.logError(App.config.endpoints[App.config.selectedEndpoint].nonstandard?"Endpoint answer was not valid.":e)},App.emptyResultSet=function(){return{name:"Results",head:[],results:[]}},App.processSparql=function(e){var r,t,n,i,s,p,a,o,l,u,c,f,d,g,h;if(i=App.emptyResultSet(),"boolean"in e.sparql)i.head.push("Boolean"),i.results.push([e.sparql["boolean"]]);else if(""!==e.sparql.head){for($.isArray(e.sparql.head.variable)||(e.sparql.head.variable=[e.sparql.head.variable]),d=e.sparql.head.variable,a=0,u=d.length;u>a;a++)p=d[a],i.head.push(p._attributes.name);for(g=e.sparql.results.result,o=0,c=g.length;c>o;o++){for(n=g[o],t=[],$.isArray(n.binding)||(n.binding=[n.binding]),h=n.binding,l=0,f=h.length;f>l;l++)r=h[l],s="","uri"in r?s=r.uri:"literal"in r?s=r.literal:"bnode"in r&&(s=r.bnode),t.push(s);i.results.push(t)}}return i},App.processTriples=function(e){var r,t,n,i,s,p,a,o,l;for(s=["subject","predicate","object"],t={name:"Triples",head:s,results:[]},p=0,o=e.length;o>p;p++){for(n=e[p],r=[],a=0,l=s.length;l>a;a++)i=s[a],r.push(n[i].value);t.results.push(r)}return t},App.processPredicates=function(e){var r,t,n,i,s,p,a,o,l,u,c,f,d,g;if(s={name:"Predicates",head:[],results:[]},s.head.push("Predicate Name"),e[0].parameters)for(d=e[0].parameters,r=a=0,u=d.length;u>a;r=++a)p=d[r],s.head.push("Arg. "+(r+1));for(o=0,c=e.length;c>o;o++){if(n=e[o],i=[],i.push(n.predicateName.value),n.parameters)for(g=n.parameters,l=0,f=g.length;f>l;l++)t=g[l],i.push(t.datatype?'"'+t.value+'"^^'+t.datatype:'"'+t.value+'"');s.results.push(i)}return s},App.prefixResultSets=function(e,r,t){var n,i,s,p,a,o,l;for(l=[],a=0,o=e.length;o>a;a++)p=e[a],l.push(function(){var e,a,o,l;for(o=p.results,l=[],e=0,a=o.length;a>e;e++)s=o[e],l.push(function(){var e,p,a;for(a=[],i=e=0,p=s.length;p>e;i=++e)n=s[i],a.push(s[i]=App.replacePrefixes(n,r,t));return a}());return l}());return l},App.replacePrefixes=function(e,r,t){var n,i,s;e=_.escape(e);for(i in r)if(s=r[i],-1!==e.indexOf(s))return e.replace(s,JST["results/prefix"]({prefix:i,color:t[i]}));return n=App.baseName(e),e.replace(n,"<em>"+n+"</em>")},App.parseRDFPrefixes=function(e){var r,t,n;for(n=/@prefix\s+([A-z0-9-]+):\s*<([^>]+)>\s+\./g,t={};r=n.exec(e);)t[r[1]]=r[2];return t},App.parseRIFPrefixes=function(e){var r,t,n;for(n=/Prefix\(([^\s]+)\s+<([^>]+)>\)/g,t={};r=n.exec(e);)t[r[1]]=r[2];return t},App.logError=function(e,r,t){return r&&t&&(t--,App.cm[r].setSelection({line:t,ch:0},{line:t,ch:80}),$("."+r+"-tab a").click()),$("#results-tab").html(JST["results/error"]({msg:e}))},App.baseName=function(e){var r;return r=new String(e).substring(e.lastIndexOf("/")+1),-1!==r.lastIndexOf(".")&&(r=r.substring(0,r.lastIndexOf("."))),r},App.configComponents={Radio:function(e,r,t){return $(e).change(function(){return t($(e).filter(":checked").val()),!0}),r?$(e).filter("[value="+r+"]").click():void 0},Check:function(e,r,t){return $(e).click(function(){return t($(e).is(":checked")),!0}),r?$(e).click():void 0}},App.initConfigComponents=function(){var e,r,t,n,i,s,p;for(s=App.config.hiddenTabs,r=0,n=s.length;n>r;r++)e=s[r],$("#"+e+"-tab").hide().removeClass("active"),$("a[href=#"+e+"-tab]").parent("dd").hide().removeClass("active");for(delay(1e3,function(){return $(".tabs").each(function(){return $(this).find("dd:visible a").first().click()})}),p=App.config.readOnlyTabs,t=0,i=p.length;i>t;t++)e=p[t],$("#"+e+"-tab, a[href=#"+e+"-tab]").addClass("read-only"),$("#"+e+"-tab").find("input, textarea, select").attr("readonly",!0);return App.configComponents.Radio("#rule_radios input",App.config.queryParameters.inference,function(e){return App.config.queryParameters.inference=e}),App.configComponents.Check("#send_rdf",App.config.sendRDF,function(e){return App.config.sendRDF=e})},delay=function(e,r){return setTimeout(r,e)},$(document).ready(function(){return App.init()});